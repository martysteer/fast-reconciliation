# FAST Reconciliation Service
#
# Quick start:
#   docker compose up -d          # Start service (builds DB on first run)
#   docker compose logs -f        # Watch logs
#   docker compose down           # Stop
#
# Commands:
#   docker compose run --rm fast make status
#   docker compose run --rm fast make test
#   docker compose run --rm fast make clean
#   docker compose run --rm fast make update

services:
  fast:
    build: .
    container_name: fast-reconcile
    ports:
      - "8001:8001"
    volumes:
      # Persist downloaded data and database between container restarts
      - fast-data:/app/data
      # Mount metadata for live editing (remove :ro to allow edits)
      - ./fast.metadata.json:/app/fast.metadata.json:ro
    environment:
      - DOCKER=1
      - DATA_DIR=/app/data
      - PUBLIC=1
    restart: unless-stopped
    # On first run, build the database, then serve
    command: >
      bash -c "
        if [ ! -f /app/data/fast.db ]; then
          echo ''
          echo '════════════════════════════════════════════════════════════════'
          echo 'First run - downloading data and building database...'
          echo 'This will take 30-60 minutes. Go get a coffee ☕'
          echo '════════════════════════════════════════════════════════════════'
          echo ''
          make build DOCKER=1
        fi
        exec make serve DOCKER=1 PUBLIC=1
      "

volumes:
  fast-data:
    name: fast-reconcile-data
